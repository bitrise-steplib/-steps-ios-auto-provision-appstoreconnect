format_version: 11
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
    # An example secret param, define it (A_SECRET_PARAM) in .bitrise.secrets.yml
    - KEYCHAIN_PATH: $HOME/Library/Keychains/login.keychain
    - BITRISE_KEYCHAIN_PASSWORD: $BITRISE_KEYCHAIN_PASSWORD

    # Used for development
    - LOCAL_SAMPLE_PATH: $LOCAL_SAMPLE_PATH
    - LOCAL_PROJECT_NAME: $LOCAL_PROJECT_NAME
    - LOCAL_SCHEME: $LOCAL_SCHEME
    - $LOCAL_KEYCHAIN_PATH: $LOCAL_KEYCHAIN_PATH

    - API_TOKEN: $API_TOKEN
    - APP_SLUG: $APP_SLUG

workflows:
  test:
    before_run:
      - audit-this-step
    steps:
      - go-list:
      - golint:
      - errcheck:
      - go-test:
      - codecov:
          run_if: .IsCI
          inputs:
          - other_options: -f ${GO_CODE_COVERAGE_REPORT_PATH}
          - CODECOV_TOKEN: "$CODECOV_UPLOAD_TOKEN"
      - trigger-bitrise-workflow:
          run_if: .IsCI
          inputs:
            - api_token: "$API_TOKEN"
            - app_slug: "$APP_SLUG"
            - workflow_id: test_entitlements
      - trigger-bitrise-workflow:
          run_if: .IsCI
          inputs:
            - api_token: "$API_TOKEN"
            - app_slug: "$APP_SLUG"
            - workflow_id: test_entitlements
      - trigger-bitrise-workflow:
          run_if: .IsCI
          inputs:
            - api_token: "$API_TOKEN"
            - app_slug: "$APP_SLUG"
            - workflow_id: test_entitlements
    after_run:
      - test_uitest_target
      - test_bundle_id
      - test_xcode_managed
      - test_xcode_managed_generate_enabled
      - test_workspace
      - test_tvos
      - test_tvos_development
      - test_tvos_managed
      - test_tvos_development_managed

  debug:
    envs:
      - SAMPLE_APP_URL: $LOCAL_SAMPLE_PATH
      - BITRISE_PROJECT_PATH: $LOCAL_PROJECT_NAME
      - BITRISE_SCHEME: $LOCAL_SCHEME
      - BITRISE_CONFIGURATION: Debug
      - DISTRIBUTION_TYPE: development
      - GENERATE_PROFILES: "yes"
      - KEYCHAIN_PATH: $LOCAL_KEYCHAIN_PATH
      - CONNECTION: "automatic"
      - API_KEY_PATH: $API_KEY_PATH
      - API_ISSUER: $API_ISSUER
    after_run:
      - _common

  audit-this-step:
    steps:
      - script:
          inputs:
            - content: |-
                #!/bin/bash
                set -ex
                stepman audit --step-yml ./step.yml
